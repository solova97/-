---1) Определяем регионы с наибольшим количеством зарегистрированных доноров.
SELECT region, COUNT(id) AS count_id
FROM donorsearch.user_anon_data uad
WHERE registration_date IS NOT NULL
GROUP BY region 
ORDER BY COUNT(id) DESC
LIMIT 5;
-- Таблица:
-- region                               | donor_count
-- -------------------------------------|-------------
--                                      | 100574
-- Россия, Москва                       | 37819
-- Россия, Санкт-Петербург              | 13137
-- Россия, Татарстан, Казань            | 6610
-- Украина, Киевская область, Киев      | 3541
-- На первом месте крупные города, однако также много донаций без места и это стоит исправить

---2) Изучаем динамику общего количества донаций в месяц за 2022 и 2023 годы.
SELECT DATE_TRUNC('month', donation_date) AS month, COUNT(id)
FROM donorsearch.donation_anon da 
WHERE donation_date BETWEEN '20220101' AND '20231231'
GROUP BY month 
ORDER BY month;
-- Таблица:
-- month          | donation_count 
-- ---------------|----------------
-- 2022-01-01     |           1977
-- 2022-02-01     |           2109
-- 2022-03-01     |           3002
-- и так далее...

-- В 2022 году наблюдается устойчивый рост активности доноров в течение года за исключением небольших спадов в мае и июне.
-- В 2023 году наблюдается спад активности доноров в середине и конце года по сравнению с началом года.
-- В оба года наблюдаются пики активности в весенние месяцы март и апрель.

-- Рекомендации:
-- Увеличить маркетинговые и рекламные кампании в летние месяцы, чтобы компенсировать снижение активности доноров.
-- Провести дополнительные акции и мероприятия в конце года (октябрь-ноябрь), чтобы увеличить количество донаций.
-- Проводить регулярные кампании по привлечению доноров в течение всего года, с особыми акцентами на периоды снижения активности.

---3)Определяем наиболее активных доноров в системе, учитывая только данные о зарегистрированных и подтвержденных донациях.
SELECT id, confirmed_donations
FROM donorsearch.user_anon_data uad
ORDER BY confirmed_donations DESC 
LIMIT 5;

-- Таблица:
-- id     | confirmed_donations 
-- -------|---------------------
-- 235391 | 361
-- 273317 | 257
-- 211970 | 236
-- и так далее...

-- Доноры с наибольшим количеством донаций показывают высокую степень вовлечённости и лояльности.
-- У донора с ID 235391 большое количество донаций (361), что указывает на его исключительную активность.
-- Эти доноры могут быть основой для создания программ лояльности и награждения, чтобы поддерживать их активность и стимулировать других доноров.

-- Рекомендации:
-- Создать специальные программы и награды для наиболее активных доноров: донорские значки, сертификаты, публичное признание и дополнительные бонусы.
-- Включить истории этих доноров в маркетинговые кампании для мотивации других.
-- Провести опросы или интервью с этими донорами, чтобы понять, что их мотивирует, и использовать эти знания для привлечения и удержания других доноров.

---4)Оценить, как система бонусов влияет на зарегистрированные в системе донации.
WITH donor_activity AS
  (SELECT u.id,
          u.confirmed_donations,
          COALESCE(b.user_bonus_count, 0) AS user_bonus_count
   FROM donorsearch.user_anon_data u
   LEFT JOIN donorsearch.user_anon_bonus b ON u.id = b.user_id)
SELECT CASE
           WHEN user_bonus_count > 0 THEN 'Получили бонусы'
           ELSE 'Не получали бонусы'
       END AS статус_бонусов,
       COUNT(id) AS количество_доноров,
       AVG(confirmed_donations) AS среднее_количество_донаций
FROM donor_activity
GROUP BY статус_бонусов;
-- Таблица:
-- статус_бонусов     | количество_доноров | среднее_количество_донаций 
-- -------------------|--------------------|----------------------------
-- Получили бонусы    | 21108              | 13.90
-- Не получали бонусы | 256491             | 0.53


-- Доноры, которые получили бонусы, в среднем делают значительно больше донаций (~13.90), чем те, кто не получил бонусы (~0.53).
-- Это свидетельствует о сильном положительном влиянии программ лояльности на активность доноров.
-- Всего 21108 доноров получили бонусы, что значительно меньше по сравнению с общей базой доноров (256491). Это указывает на потенциал расширения программ лояльности для охвата большего числа доноров.

-- Рекомендации:
-- Увеличить количество бонусов и наград для доноров, чтобы охватить большее количество людей.
-- Проводить более активные маркетинговые кампании, чтобы доноры знали о возможности получить бонусы за свои донации.
-- Создавать специальные акции и кампании, направленные на доноров, которые ещё не получили бонусы, чтобы мотивировать их к участию.
-- Создавать программы для удержания наиболее активных доноров и поощрять их за продолжение участия в донорских мероприятиях.

---4) Исследуем вовлечение новых доноров через социальные сети. Узнать, сколько по каким каналам пришло доноров, и среднее количество донаций по каждому каналу.
SELECT CASE
           WHEN autho_vk THEN 'ВКонтакте'
           WHEN autho_ok THEN 'Одноклассники'
           WHEN autho_tg THEN 'Telegram'
           WHEN autho_yandex THEN 'Яндекс'
           WHEN autho_google THEN 'Google'
           ELSE 'Без авторизации через соцсети'
       END AS социальная_сеть,
       COUNT(id) AS количество_доноров,
       AVG(confirmed_donations) AS среднее_количество_донаций
FROM donorsearch.user_anon_data
GROUP BY социальная_сеть;
-- Таблица:
-- социальная_сеть        | количество_доноров | среднее_количество_донаций 
-- -----------------------|--------------------|----------------------------
-- Google                 | 14292              | 1.08
-- Telegram               | 481                | 1.17
-- ВКонтакте              | 127254             | 0.91
-- и так далее...


-- Доноры, авторизованные через Яндекс, показывают наибольшее среднее количество подтверждённых донаций (~1.73), что указывает на высокую степень вовлечённости.
-- Telegram также показывает высокий уровень активности (~1.17), хотя количество доноров, авторизованных через мессенджер, значительно меньше.
-- Google и ВКонтакте имеют среднюю активность доноров (~1.08 и ~0.91 соответственно), при этом ВКонтакте является крупнейшей группой по количеству доноров.
-- Одноклассники имеют наименьшее среднее количество подтверждённых донаций (~0.56), что указывает на меньшую вовлечённость доноров, авторизованных через эту сеть.
-- Доноры, не использующие социальные сети для авторизации, также показывают низкий уровень активности (~0.71).

-- Рекомендации:
-- Увеличить маркетинговые усилия на платформах Яндекс и Telegram, так как они показывают наибольшую активность доноров.
-- Разработать специальные предложения и кампании для доноров, авторизованных через эти сети.
-- Проанализировать причины меньшей активности в Одноклассниках и разработать стратегии для повышения вовлечённости доноров, использующих эту сеть.
-- Стимулировать доноров, не использующих социальные сети, специальными кампаниями и предложениями.
-- Внедрить программы лояльности и награды, ориентированные на доноров из различных социальных сетей, чтобы поддерживать их активность и мотивацию.
---5) Сравниваем активность однократных доноров со средней активностью повторных доноров.
WITH donor_activity AS (
  SELECT user_id,
         COUNT(*) AS total_donations,
         (MAX(donation_date) - MIN(donation_date)) AS activity_duration_days,
         (MAX(donation_date) - MIN(donation_date)) / (COUNT(*) - 1) AS avg_days_between_donations,
         EXTRACT(YEAR FROM MIN(donation_date)) AS first_donation_year,
         EXTRACT(YEAR FROM AGE(CURRENT_DATE, MIN(donation_date))) AS years_since_first_donation
  FROM donorsearch.donation_anon
  GROUP BY user_id
  HAVING COUNT(*) > 1
)
SELECT first_donation_year,
       CASE 
           WHEN total_donations BETWEEN 2 AND 3 THEN '2-3 донации'
           WHEN total_donations BETWEEN 4 AND 5 THEN '4-5 донаций'
           ELSE '6 и более донаций'
       END AS donation_frequency_group,
       COUNT(user_id) AS donor_count,
       AVG(total_donations) AS avg_donations_per_donor,
       AVG(activity_duration_days) AS avg_activity_duration_days,
       AVG(avg_days_between_donations) AS avg_days_between_donations,
       AVG(years_since_first_donation) AS avg_years_since_first_donation
FROM donor_activity
GROUP BY first_donation_year, donation_frequency_group
ORDER BY first_donation_year, donation_frequency_group;
  
-- -- Таблица:

-- 201	6 и более донаций	1	26.0000000000000000	663670.000000000000	26546.000000000000	1823.0000000000000000
-- 207	6 и более донаций	1	37.0000000000000000	661775.000000000000	18382.0000000000000000	1817.0000000000000000
-- 208	6 и более донаций	1	7.0000000000000000	660907.000000000000	110151.000000000000	1816.0000000000000000
-- 214	6 и более донаций	1	39.0000000000000000	658841.000000000000	17337.0000000000000000	1809.0000000000000000
-- 1019	6 и более донаций	1	33.0000000000000000	366097.000000000000	11440.0000000000000000	1004.0000000000000000
-- 1900	6 и более донаций	1	7.0000000000000000	45136.000000000000	7522.0000000000000000	124.0000000000000000

-- Выводы:
-- Аномальные данные: В текущем наборе данных были обнаружены серьёзные аномалии, такие как 
-- очень длительные периоды активности доноров (до 1800 лет) и большие промежутки между донациями.
--  Это свидетельствует о наличии ошибок в данных, особенно в части корректности указания дат донаций. 
--  Возможно, такие ошибки связаны с ручным вводом данных или некорректной обработкой при переносе из других источников.

-- Активность повторных доноров: Несмотря на аномалии, можно предположить, что повторные доноры демонстрируют 
-- большую вовлечённость и остаются активными в течение длительного времени. Однако без очистки данных 
-- точные цифры для интерпретации этих тенденций недоступны.

-- Необходимость фильтрации и чистки данных: Для получения корректных выводов требуется фильтрация по
--  допустимому диапазону дат и пересмотр всех расчетов после очистки данных. Это позволит выявить реальный 
--  уровень активности доноров и сделать более точные выводы о средней частоте донаций и продолжительности участия доноров в программе.

-- Повторные доноры — ключевая аудитория: Исходя из структуры данных, повторные доноры играют ключевую роль 
-- в донорских программах, и работа с их поддержанием крайне важна. Они совершают большее количество донаций,
--  что требует внимательного анализа и создания программ удержания.

-- Дальнейшие шаги:
-- После очистки данных, ключевой вывод о том, что повторные доноры делают большее количество донаций и остаются активными дольше, можно будет подтвердить с точными показателями.
-- Создание специальных программ, направленных на поддержку и увеличение активности повторных доноров, станет приоритетной задачей.

--- Задача 7. Проанализировать планирования доноров и их реальной активности
WITH planned_donations AS (
  SELECT DISTINCT user_id, donation_date, donation_type
  FROM donorsearch.donation_plan
),
actual_donations AS (
  SELECT DISTINCT user_id, donation_date
  FROM donorsearch.donation_anon
),
planned_vs_actual AS (
  SELECT
    pd.user_id,
    pd.donation_date AS planned_date,
    pd.donation_type,
    CASE WHEN ad.user_id IS NOT NULL THEN 1 ELSE 0 END AS completed
  FROM planned_donations pd
  LEFT JOIN actual_donations ad ON pd.user_id = ad.user_id AND pd.donation_date = ad.donation_date
)
SELECT
  donation_type,
  COUNT(*) AS total_planned_donations,
  SUM(completed) AS completed_donations,
  ROUND(SUM(completed) * 100.0 / COUNT(*), 2) AS completion_rate
FROM planned_vs_actual
GROUP BY donation_type;

    
-- |donation_type|total_planned_donations|completed_donations|completion_rate|
-- |-------------|-----------------------|-------------------|---------------|
-- |Безвозмездно |          22903        |        4950       |      21.61    |
-- |Платно       |          3299         |        429        |      13.00    |

-- Из представленных данных видно, что процент выполнения планов донаций 
-- низок для обоих типов доноров: 21.61% для безвозмездных и 13.00% для платных.
-- Это указывает на необходимость повышения вовлечённости доноров, особенно платных.
-- Рекомендуется провести мероприятия по мотивации доноров, такие как программы поощрения
-- и улучшение коммуникации о важности донорства.


-- Итоговые рекомендации:

-- Региональные кампании: усилить маркетинговые усилия в регионах с низкой активностью доноров, чтобы увеличить их вовлечённость.
-- Программы лояльности: расширить охват программ лояльности и обеспечить, чтобы доноры были осведомлены о возможностях получения бонусов за донации.
-- Вовлечение через социальные сети: активнее использовать платформы Яндекс и Telegram для привлечения доноров, а также разработать стратегии для повышения вовлечённости через Одноклассники.
-- Поддержка повторных доноров: сосредоточиться на удержании и мотивации однократных доноров, чтобы увеличить их активность и сделать их постоянными участниками донорских программ.